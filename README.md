# LOBå›æµ‹ç³»ç»Ÿ (Limit Order Book Backtesting System)

[![Python Version](https://img.shields.io/badge/python-3.8%2B-blue.svg)](https://www.python.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Build Status](https://img.shields.io/badge/build-passing-brightgreen.svg)](https://github.com/Cunzhi/LOB-backtest)
[![Code Style: Black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

## é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®¢å•ç°¿çº§åˆ«æ’®åˆå›æµ‹ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºå¯¹äº¤æ˜“ä¿¡å·è¿›è¡Œé«˜ç²¾åº¦çš„å›æµ‹åˆ†æã€‚ç³»ç»Ÿæ”¯æŒåæ¡£ç›˜å£æ•°æ®å¤„ç†ã€æ·±åº¦å­¦ä¹ ä¿¡å·é›†æˆã€å®æ—¶æ’®åˆæ¨¡æ‹Ÿå’Œå…¨é¢çš„æ€§èƒ½åˆ†æã€‚

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ”„ æ•°æ®å¤„ç†æ¨¡å—
- **åæ¡£ç›˜å£æ•°æ®åŠ è½½**: æ”¯æŒCSVæ ¼å¼çš„ç§’çº§ç›˜å£æ•°æ®ï¼Œå¼ºåˆ¶ä½¿ç”¨åŒ—äº¬æ—¶é—´
- **æ·±åº¦å­¦ä¹ ä¿¡å·å¤„ç†**: å¤„ç†æ¨¡å‹é¢„æµ‹ç»“æœï¼Œæ”¯æŒå¤šç§é˜ˆå€¼ç­–ç•¥
- **æ•°æ®æ¸…ç†ä¸éªŒè¯**: è‡ªåŠ¨å¤„ç†æ¶¨è·Œåœã€å¼‚å¸¸å€¼å’Œç¼ºå¤±æ•°æ®

### âš¡ é«˜æ€§èƒ½æ’®åˆå¼•æ“
- **Numba JITä¼˜åŒ–**: æ ¸å¿ƒæ’®åˆç®—æ³•ä½¿ç”¨JITç¼–è¯‘ï¼Œç¡®ä¿æœ€é«˜æ€§èƒ½
- **å…¨æ¡£ä½æ’®åˆ**: çœŸå®æ¨¡æ‹Ÿå¸‚åœºæ·±åº¦æ¶ˆè€—å’Œæ»‘ç‚¹å½±å“
- **å»¶è¿Ÿæ¨¡æ‹Ÿ**: å¯é…ç½®çš„tickå»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸå®äº¤æ˜“ç¯å¢ƒ
- **å…¨ä»“æ¨¡å¼**: æ”¯æŒAll-inäº¤æ˜“ç­–ç•¥

### ğŸ“Š æ€§èƒ½åˆ†æä¸å¯è§†åŒ–
- **ä¸šç•Œæ ‡å‡†æŒ‡æ ‡**: å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ã€èƒœç‡ã€ç›ˆäºæ¯”ç­‰
- **åŸºå‡†å¯¹æ¯”**: ä¸ä¹°å…¥å¹¶æŒæœ‰ç­–ç•¥å¯¹æ¯”
- **é™æ€å›¾è¡¨**: å‡€å€¼æ›²çº¿ã€å›æ’¤å›¾ã€äº¤æ˜“åˆ†æï¼ˆmatplotlibï¼‰
- **äº¤äº’å¼å›¾è¡¨**: åŸºäºlightweight-chartsçš„äº¤äº’å¼å¯è§†åŒ–ï¼ˆæ”¯æŒæ ‡è®°ã€ç¼©æ”¾ã€æ—¶é—´èŒƒå›´åˆ‡æ¢ï¼‰
- **è¯¦ç»†æŠ¥å‘Š**: è‡ªåŠ¨ç”ŸæˆPDFæ ¼å¼çš„å›æµ‹æŠ¥å‘Š

## é¡¹ç›®ç»“æ„

```
lob_backtest/
â”œâ”€â”€ lob_backtest/                 # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ data/                     # æ•°æ®å¤„ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ lob_data_loader.py    # åæ¡£ç›˜å£æ•°æ®åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ signal_data_loader.py # ä¿¡å·æ•°æ®åŠ è½½å™¨
â”‚   â”œâ”€â”€ engine/                   # æ’®åˆå¼•æ“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ order_book.py         # è®¢å•ç°¿æ¨¡æ‹Ÿå™¨
â”‚   â”‚   â””â”€â”€ matching_engine.py    # æ’®åˆå¼•æ“æ ¸å¿ƒ
â”‚   â”œâ”€â”€ analysis/                 # åˆ†ææ¨¡å—
â”‚   â”‚   â”œâ”€â”€ performance_metrics.py # æ€§èƒ½æŒ‡æ ‡è®¡ç®—
â”‚   â”‚   â””â”€â”€ visualization.py      # å¯è§†åŒ–æ¨¡å—
â”‚   â””â”€â”€ utils/                    # å·¥å…·æ¨¡å—
â”‚       â””â”€â”€ config.py             # é…ç½®ç®¡ç†
â”œâ”€â”€ config/                       # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ backtest_config.yaml      # å›æµ‹é…ç½®
â”œâ”€â”€ docs/                         # å®Œæ•´æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md                 # æ–‡æ¡£ä¸­å¿ƒ
â”‚   â”œâ”€â”€ Installation_Guide.md     # å®‰è£…æŒ‡å—
â”‚   â”œâ”€â”€ User_Guide.md             # ç”¨æˆ·æŒ‡å—
â”‚   â”œâ”€â”€ API_Reference.md          # APIå‚è€ƒ
â”‚   â”œâ”€â”€ Technical_Specification.md # æŠ€æœ¯è§„æ ¼
â”‚   â””â”€â”€ FAQ.md                    # å¸¸è§é—®é¢˜
â”œâ”€â”€ å‚è€ƒ/                         # å‚è€ƒä»£ç 
â”‚   â”œâ”€â”€ æ ¼å¼åŒ–åæ¡£ç›˜å£æ•°æ®.py      # æ•°æ®æ ¼å¼åŒ–å‚è€ƒ
â”‚   â””â”€â”€ å›æµ‹ç»“æœå¯è§†åŒ–.py          # å¯è§†åŒ–å‚è€ƒ
â”œâ”€â”€ test_with_sample_data.py      # æµ‹è¯•è„šæœ¬ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
â”œâ”€â”€ main.py                       # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ requirements.txt              # ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ README.md                     # é¡¹ç›®æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. è¿è¡Œæµ‹è¯•

ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®éªŒè¯æ‰€æœ‰åŠŸèƒ½ï¼š

```bash
# ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•ç³»ç»Ÿ
python test_with_sample_data.py
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- ç”Ÿæˆä¸€å¤©çš„æ¨¡æ‹Ÿåæ¡£ç›˜å£æ•°æ®ï¼ˆ6.5å°æ—¶äº¤æ˜“æ—¶é—´ï¼‰
- ç”Ÿæˆå¯¹åº”çš„æ·±åº¦å­¦ä¹ ä¿¡å·æ•°æ®
- è¿è¡Œå®Œæ•´çš„å›æµ‹æµç¨‹
- è¾“å‡ºæ€§èƒ½æŒ‡æ ‡å’Œå¯è§†åŒ–æŠ¥å‘Š

**é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š**
```
âœ… æ‰€æœ‰ç³»ç»Ÿç»„ä»¶éªŒè¯é€šè¿‡
æ­£åœ¨ç”Ÿæˆæ¨¡æ‹ŸLOBæ•°æ®...
ç”Ÿæˆäº† 7800 æ¡LOBè®°å½•
æ­£åœ¨ç”Ÿæˆæ¨¡æ‹Ÿä¿¡å·æ•°æ®...
ç”Ÿæˆäº† 1560 æ¡ä¿¡å·è®°å½•
âœ… å›æµ‹æˆåŠŸå®Œæˆ!
ğŸ“Š å…³é”®æŒ‡æ ‡:
   æ€»æ”¶ç›Šç‡: 2.34%
   å¹´åŒ–æ”¶ç›Šç‡: 15.67%
   æœ€å¤§å›æ’¤: -1.23%
   å¤æ™®æ¯”ç‡: 1.456
   æ€»äº¤æ˜“æ¬¡æ•°: 23
   èƒœç‡: 65.22%
```

### 3. ä½¿ç”¨çœŸå®æ•°æ®

```python
from main import LOBBacktester

# åˆå§‹åŒ–å›æµ‹ç³»ç»Ÿ
backtester = LOBBacktester()

# è¿è¡Œå›æµ‹
results = backtester.run_backtest(
    lob_data_path="path/to/lob_data.csv",
    signal_data_path="path/to/signal_data.csv",
    symbol="YOUR_SYMBOL"
)
```

## æ•°æ®æ ¼å¼è¦æ±‚

### åæ¡£ç›˜å£æ•°æ®æ ¼å¼
```csv
æ—¶é—´,å–10ä»·,å–10é‡,å–9ä»·,å–9é‡,...,å–1ä»·,å–1é‡,ä¹°1ä»·,ä¹°1é‡,...,ä¹°10ä»·,ä¹°10é‡,å–å‡,ä¹°å‡
2025-06-03 09:30:05,1.370,12868,1.369,8999,...,1.361,16615,1.360,4394,...,1.351,6624,1.389,1.330
```

### æ·±åº¦å­¦ä¹ ä¿¡å·æ•°æ®æ ¼å¼
```csv
timestamp,target,has_pos,0,1
1725865015,1.0,0,0.5339759,0.46602404
1725865015,1.0,1,0.50600046,0.49399954
```

## é…ç½®è¯´æ˜

ä¸»è¦é…ç½®é¡¹åœ¨ `config/backtest_config.yaml` ä¸­ï¼š

```yaml
# ä¿¡å·é…ç½®
signal:
  source: "predict"              # target/predict
  predict_threshold: "max"       # max/æ•°å€¼

# äº¤æ˜“é…ç½®  
trading:
  delay_ticks: 0                # å»¶è¿Ÿtickæ•°
  commission_rate: 5e-5         # æ‰‹ç»­è´¹ç‡
  all_in_mode: true             # å…¨ä»“æ¨¡å¼
  initial_capital: 1000000      # åˆå§‹èµ„é‡‘

# æ’®åˆå¼•æ“é…ç½®
matching:
  order_type: "market"          # è®¢å•ç±»å‹ (ç›®å‰ä»…æ”¯æŒå¸‚ä»·å•)
  slippage_model: "market_impact" # æ»‘ç‚¹æ¨¡å‹ (åŸºäºè®¢å•ç°¿æ·±åº¦çš„å¸‚åœºå†²å‡»æ¨¡å‹)
  use_all_levels: true          # æ˜¯å¦ä½¿ç”¨å…¨éƒ¨æ¡£ä½è¿›è¡Œæ’®åˆ

# å¯è§†åŒ–é…ç½®
visualization:
  enable: true                  # å¯ç”¨é™æ€å¯è§†åŒ–
  save_plots: true              # ä¿å­˜é™æ€å›¾è¡¨
  plot_format: "png"            # å›¾è¡¨æ ¼å¼
  interactive: false             # å¯ç”¨äº¤äº’å¼å¯è§†åŒ–ï¼ˆéœ€è¦æ‰‹åŠ¨å¯åŠ¨ï¼‰
```

## è¾“å‡ºæ–‡ä»¶

ç³»ç»Ÿä¼šåœ¨ `results/` ç›®å½•ä¸‹ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

- `{symbol}_asset_nets.csv`: èµ„äº§å‡€å€¼å†å²
- `{symbol}_trades.csv`: è¯¦ç»†äº¤æ˜“è®°å½•  
- `{symbol}_metrics.json`: æ€§èƒ½æŒ‡æ ‡
- `backtest_report.png`: å¯è§†åŒ–æŠ¥å‘Š
- `trade_analysis.png`: äº¤æ˜“åˆ†æå›¾

## æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

### é«˜æ€§èƒ½è®¡ç®—
- ä½¿ç”¨Numba JITç¼–è¯‘ä¼˜åŒ–æ’®åˆç®—æ³•
- å‘é‡åŒ–æ•°æ®å¤„ç†ï¼Œæ”¯æŒå¤§è§„æ¨¡æ•°æ®é›†
- å†…å­˜ä¼˜åŒ–ï¼Œæ”¯æŒé•¿æ—¶é—´å›æµ‹

### ç²¾ç¡®æ’®åˆæ¨¡æ‹Ÿ
- å…¨æ¡£ä½å¸‚ä»·å•æ’®åˆ
- åŸºäºè®¢å•ç°¿æ·±åº¦çš„åŠ¨æ€æ»‘ç‚¹æ¨¡å‹
- çœŸå®çš„æ‰‹ç»­è´¹å’Œå»¶è¿Ÿæ¨¡æ‹Ÿ

### ä¸“ä¸šåˆ†æ
- 20+ä¸šç•Œæ ‡å‡†æ€§èƒ½æŒ‡æ ‡
- é£é™©è°ƒæ•´æ”¶ç›Šåˆ†æ
- äº¤æ˜“è¡Œä¸ºç»Ÿè®¡åˆ†æ

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€å›æµ‹
```python
from main import LOBBacktester

backtester = LOBBacktester()
results = backtester.run_backtest(
    lob_data_path="data/lob.csv",
    signal_data_path="data/signals.csv", 
    symbol="ETF_513330"
)

print(f"æ€»æ”¶ç›Šç‡: {results['metrics']['total_return']:.2%}")
print(f"å¤æ™®æ¯”ç‡: {results['metrics']['sharpe_ratio']:.3f}")
```

### è‡ªå®šä¹‰é…ç½®
```python
from utils.config import BacktestConfig

# ä¿®æ”¹é…ç½®
config = BacktestConfig()
config.set('trading.commission_rate', 1e-4)  # è°ƒæ•´æ‰‹ç»­è´¹
config.set('signal.predict_threshold', 0.6)  # è°ƒæ•´ä¿¡å·é˜ˆå€¼
config.save()

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
backtester = LOBBacktester()
```

### å¯ç”¨äº¤äº’å¼å¯è§†åŒ–
```python
from utils.config import BacktestConfig

# å¯ç”¨äº¤äº’å¼å¯è§†åŒ–
config = BacktestConfig()
config.set('visualization.interactive', True)  # å¯ç”¨äº¤äº’å¼å¯è§†åŒ–
config.save()

# è¿è¡Œå›æµ‹ï¼ˆå°†è‡ªåŠ¨å¯åŠ¨äº¤äº’å¼å¯è§†åŒ–ï¼‰
backtester = LOBBacktester()
results = backtester.run_backtest(
    lob_data_path="data/lob.csv",
    signal_data_path="data/signals.csv",
    symbol="ETF_513330"
)

# æˆ–è€…ç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®
# åœ¨ config/backtest_config.yaml ä¸­è®¾ç½®:
# visualization:
#   interactive: true
```

## æ€§èƒ½åŸºå‡†

åœ¨æ ‡å‡†æµ‹è¯•ç¯å¢ƒä¸‹ï¼ˆIntel i7, 16GB RAMï¼‰ï¼š
- å¤„ç†é€Ÿåº¦: ~1000 ticks/ç§’
- å†…å­˜ä½¿ç”¨: ~2GBï¼ˆä¸€å¤©æ•°æ®ï¼‰
- æ’®åˆå»¶è¿Ÿ: <1msï¼ˆå•æ¬¡ï¼‰

## æ³¨æ„äº‹é¡¹

1. **æ—¶åŒºå¤„ç†**: æ‰€æœ‰æ—¶é—´æ•°æ®å¼ºåˆ¶ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆAsia/Shanghaiï¼‰
2. **æ•°æ®è´¨é‡**: ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æ•°æ®å¼‚å¸¸ï¼Œä½†å»ºè®®é¢„å…ˆæ¸…ç†æ•°æ®
3. **å†…å­˜ç®¡ç†**: å¤§æ•°æ®é›†å»ºè®®åˆ†æ‰¹å¤„ç†æˆ–å¢åŠ ç³»ç»Ÿå†…å­˜
4. **ç²¾åº¦è®¾ç½®**: ä»·æ ¼ç²¾åº¦é»˜è®¤ä¸º3ä½å°æ•°ï¼Œå¯æ ¹æ®æ ‡çš„è°ƒæ•´

## æ‰©å±•å¼€å‘

æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºè´¡çŒ®è€…å¯¹æœ¬é¡¹ç›®è¿›è¡Œæ‰©å±•ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯ä»¥å…¥æ‰‹çš„æ–¹å‘ï¼š

### æ·»åŠ æ–°çš„ä¿¡å·ç­–ç•¥
åœ¨ [`signal_data_loader.py`](lob_backtest/data/signal_data_loader.py:12) ä¸­ï¼Œæ‚¨å¯ä»¥å®ç°è‡ªå·±çš„ä¿¡å·å¤„ç†é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªåŸºäºæ³¢åŠ¨ç‡çš„åŠ¨æ€é˜ˆå€¼ç­–ç•¥ã€‚

### æ·»åŠ æ–°çš„æ€§èƒ½æŒ‡æ ‡
åœ¨ [`performance_metrics.py`](lob_backtest/analysis/performance_metrics.py:16) ä¸­ï¼Œæ‚¨å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ€§èƒ½æŒ‡æ ‡ï¼Œå¦‚ç´¢æè¯ºæ¯”ç‡ï¼ˆSortino Ratioï¼‰æˆ–ä¿¡æ¯æ¯”ç‡ï¼ˆInformation Ratioï¼‰ã€‚

### è´¡çŒ®ä»£ç 
å¦‚æœæ‚¨å¸Œæœ›è´¡çŒ®ä»£ç ï¼Œè¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š
1. Fork æœ¬é¡¹ç›®
2. åˆ›å»ºæ‚¨çš„ç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ‚¨çš„ä¿®æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ä¸€ä¸ª Pull Request

## æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚
2. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
3. ä¾èµ–åŒ…æ˜¯å¦å®Œæ•´å®‰è£…
4. ç³»ç»Ÿèµ„æºæ˜¯å¦å……è¶³

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œæ¬¢è¿åœ¨ [Issues](https://github.com/Cunzhi/LOB-backtest/issues) ä¸­æå‡ºã€‚

## ç‰ˆæœ¬å†å²

- v1.0.0: åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºç¡€å›æµ‹åŠŸèƒ½
- æ ¸å¿ƒåŠŸèƒ½: LOBæ•°æ®å¤„ç†ã€ä¿¡å·é›†æˆã€æ’®åˆå¼•æ“ã€æ€§èƒ½åˆ†æ

## è®¸å¯è¯

æœ¬é¡¹ç›®ä½¿ç”¨ MIT è®¸å¯è¯ã€‚è¯¦æƒ…è¯·è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

**å¼€å‘å›¢é˜Ÿ**: æ·±åº¦å­¦ä¹ é‡‘èé‡åŒ–å·¥ç¨‹å¸ˆ  
**æŠ€æœ¯æ ˆ**: Python, Numba, Pandas, NumPy, Matplotlib  
