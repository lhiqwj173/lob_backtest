
# 技术规格说明

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    LOB回测系统架构                           │
├─────────────────────────────────────────────────────────────┤
│  用户接口层 (User Interface Layer)                          │
│  ├── main.py (主入口)                                       │
│  ├── test_with_sample_data.py (测试脚本)                    │
│  └── config/backtest_config.yaml (配置文件)                 │
├─────────────────────────────────────────────────────────────┤
│  数据处理层 (Data Processing Layer)                         │
│  ├── LOBDataLoader (十档盘口数据加载)                       │
│  └── SignalDataLoader (信号数据加载)                        │
├─────────────────────────────────────────────────────────────┤
│  核心引擎层 (Core Engine Layer)                             │
│  ├── MatchingEngine (撮合引擎)                              │
│  └── OrderBook (订单簿模拟)                                 │
├─────────────────────────────────────────────────────────────┤
│  分析与报告层 (Analysis & Reporting Layer)                  │
│  ├── PerformanceMetrics (性能指标计算)                      │
│  └── Visualization (数据可视化)                             │
└─────────────────────────────────────────────────────────────┘
```

## 配置文件详解 (`config/backtest_config.yaml`)

本部分详细解释 `config/backtest_config.yaml` 文件中的所有配置参数。

### 1. 数据源配置 (`data`)
- `lob_data_path`: (字符串) **必需**。指向十档盘口数据文件的根目录。系统会根据信号文件名中的股票代码和日期自动在该目录下查找对应的 `YYYYMMDD/<stock_id>/十档盘口.csv` 文件。
- `signal_data_path`: (字符串) **必需**。指向深度学习信号数据文件的完整路径。文件名必须遵循 `<stock_id>_<start_timestamp>_<end_timestamp>.csv` 的格式。

### 2. 信号配置 (`signal`)
- `source`: (字符串) **必需**。定义交易信号的来源。
    - `"target"`: 使用信号文件中的 `target` 列，代表理想情况下的真实信号。
    - `"predict"`: 使用模型预测的概率（`0` 和 `1` 列），更贴近实盘模拟。
- `predict_threshold`: (字符串或浮点数) **必需**。当 `source` 为 `"predict"` 时生效。
    - `"max"`: 选择概率最高的类别作为交易信号。
    - `数值` (例如 `0.6`): 当模型预测的持仓或空仓概率超过此阈值时，才生成交易信号。

### 3. 交易配置 (`trading`)
- `delay_ticks`: (整数) **必需**。信号生成后，等待多少个数据点（ticks）再执行订单。`0` 表示在下一个可用的数据点立即执行。
- `commission_rate`: (浮点数) **必需**。单边交易手续费率。例如，`0.00005` 代表万分之零点五。
- `all_in_mode`: (布尔值) **必需**。是否启用全仓交易模式。如果为 `true`，系统将在每次开仓时投入所有可用资金。
- `initial_capital`: (浮点数) **必需**。回测开始时的初始资金。
- `rest_force_close`: (布尔值) **必需**。是否在每个交易日午休收盘前（11:29:50之后）强制平仓。
- `close_force_close`: (布尔值) **必需**。是否在每个交易日下午收盘前（14:59:50之后）强制平仓。

### 4. 回测配置 (`backtest`)
- `debug`: (布尔值) **可选**。默认为 `false`。如果设置为 `true`，系统将记录详细的回测过程数据到CSV文件中，用于调试。

### 5. 撮合引擎配置 (`matching`)
- `order_type`: (字符串) **必需**。
    - **当前选项**: 仅支持 `"market"` (市价单)。系统会以最优价格立即执行订单。
- `slippage_model`: (字符串) **必需**。定义滑点模型。
    - **当前选项**: 仅支持 `"market_impact"` (市场冲击模型)。
    - **工作原理**: 这是系统内置的唯一滑点模型，无需额外配置。当提交一个市价单时，撮合引擎会根据订单量和订单簿上对手方的流动性逐级成交。如果订单量大于第一档的数量，它会继续与第二档、第三档……成交，直到订单完全被满足。这个过程会导致最终的平均成交价劣于第一档的价格，从而真实地模拟了因订单本身
